-- ===== Services =====
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ===== Main UI =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CHX_GUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0,220,0,215)
mainFrame.Position = UDim2.new(0.05,0,0.25,0)
mainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0,20)

local border = Instance.new("UIStroke")
border.Parent = mainFrame
border.Thickness = 3
border.Color = Color3.fromHSV(0,1,1)
border.LineJoinMode = Enum.LineJoinMode.Round

local hue = 0
RunService.RenderStepped:Connect(function()
    hue = (hue + 0.002) % 1
    border.Color = Color3.fromHSV(hue,1,1)
end)

-- ===== Top Bar =====
local topBar = Instance.new("Frame")
topBar.Size = UDim2.new(1,0,0,35)
topBar.Position = UDim2.new(0,0,0,0)
topBar.BackgroundTransparency = 1
topBar.Parent = mainFrame
topBar.Active = true
topBar.Selectable = true

local titleText = Instance.new("TextLabel")
titleText.Size = UDim2.new(1,-60,1,0)
titleText.Position = UDim2.new(0,5,0,0)
titleText.BackgroundTransparency = 1
titleText.Text = "CHX Brainrot"
titleText.Font = Enum.Font.GothamBold
titleText.TextSize = 18
titleText.TextColor3 = Color3.fromRGB(255,255,255)
titleText.TextXAlignment = Enum.TextXAlignment.Left
titleText.Parent = topBar

-- Close Button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0,25,0,25)
closeBtn.Position = UDim2.new(1,-5,0,5)
closeBtn.AnchorPoint = Vector2.new(1,0)
closeBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)
closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
closeBtn.Text = "X"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 14
closeBtn.Parent = topBar
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0,12)

-- Toggle Button (Mini Mode)
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0,25,0,25)
toggleBtn.Position = UDim2.new(1,-35,0,5)
toggleBtn.AnchorPoint = Vector2.new(1,0)
toggleBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
toggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
toggleBtn.Text = "-"
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 18
toggleBtn.Parent = topBar
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0,12)

-- ===== UI Container =====
local uiFrame = Instance.new("Frame")
uiFrame.Size = UDim2.new(1,0,1,-35)
uiFrame.Position = UDim2.new(0,0,0,35)
uiFrame.BackgroundTransparency = 1
uiFrame.Parent = mainFrame

-- ===== Buttons =====
local buttons = {}
local function createButton(text, y, color)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.9,0,0,35)
    btn.Position = UDim2.new(0.05,0,0,y)
    btn.BackgroundColor3 = color
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.Text = text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 16
    btn.Parent = uiFrame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,12)
    table.insert(buttons, btn)
    return btn
end

local floatBtn = createButton("Float Off",0,Color3.fromRGB(50,50,50))
local autoLaserBtn = createButton("Auto Laser OFF",45,Color3.fromRGB(70,70,70))
local functionBtn = createButton("Run Function",90,Color3.fromRGB(80,80,80))
local hopBtn = createButton("Hop Server",135,Color3.fromRGB(50,50,50))

-- ===== Toggle UI Visibility =====
local uiExpanded = true
toggleBtn.MouseButton1Click:Connect(function()
    uiExpanded = not uiExpanded
    if uiExpanded then
        mainFrame.Size = UDim2.new(0,220,0,215)
        uiFrame.Visible = true
        for _,btn in ipairs(buttons) do btn.Visible = true end
        toggleBtn.Text = "-"
    else
        mainFrame.Size = UDim2.new(0,220,0,35)
        uiFrame.Visible = false
        for _,btn in ipairs(buttons) do btn.Visible = false end
        toggleBtn.Text = "+"
    end
end)

-- ===== Drag Main Frame =====
local dragging = false
local dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(
        startPos.X.Scale,
        startPos.X.Offset + delta.X,
        startPos.Y.Scale,
        startPos.Y.Offset + delta.Y
    )
end

-- เริ่มลาก
topBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        dragInput = input -- เซ็ต dragInput เพื่อใช้กับ InputChanged

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

-- อัปเดตตำแหน่งขณะลาก
topBar.InputChanged:Connect(function(input)
    if input == dragInput then
        update(input)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput then
        update(input)
    end
end)


-- ===== State Variables =====
local Floating = false
local AutoLaser = false

-- ===== Float Button Logic =====
floatBtn.MouseButton1Click:Connect(function()
    Floating = not Floating
    if Floating then
        floatBtn.Text = "Float ON"
        local url = "https://raw.githubusercontent.com/Chxtoqfee12/Chx-Braintoy/refs/heads/main/Float"
        pcall(function() loadstring(game:HttpGet(url))() end)
    else
        floatBtn.Text = "Float Off"
        local floatUI = playerGui:FindFirstChild("FloatUI")
        if floatUI then floatUI:Destroy() end
        if typeof(disableFloat) == "function" then pcall(disableFloat) end
    end
end)

-- ===== Auto Laser Button Logic =====
autoLaserBtn.MouseButton1Click:Connect(function()
    AutoLaser = not AutoLaser
    if AutoLaser then
        autoLaserBtn.Text = "Auto Laser ON"
        local url = "https://raw.githubusercontent.com/Chxtoqfee12/Chx-Braintoy/refs/heads/main/Laser"
        pcall(function() loadstring(game:HttpGet(url))() end)
    else
        autoLaserBtn.Text = "Auto Laser OFF"
        local laserUI = playerGui:FindFirstChild("AutoLaserUI")
        if laserUI then laserUI:Destroy() end
        if typeof(unequipLaser) == "function" then pcall(unequipLaser) end
    end
end)

-- ===== Function Button =====
functionBtn.MouseButton1Click:Connect(function()
    local url = "https://raw.githubusercontent.com/Chxtoqfee12/Chx-Braintoy/refs/heads/main/src%20function"
    pcall(function() loadstring(game:HttpGet(url))() end)
end)

-- ===== Hop Server Button =====
hopBtn.MouseButton1Click:Connect(function()
    getgenv().ALLOWED_PLACE_ID = 109983668079237
    getgenv().RETRY_DELAY = 2
    getgenv().MIN_PLAYERS = 2
    getgenv().MAX_PLAYERS = 7
    getgenv().CHECK_COOLDOWN = 5
    getgenv().SOUND_ID = 91907916191505
    getgenv().MODEL_SEARCH_SETTINGS = {}

    spawn(function()
        while true do
            task.spawn(function()
                local success, err = pcall(function()
                    loadstring(game:HttpGet("https://raw.githubusercontent.com/Chxtoqfee12/Chx-Braintoy/refs/heads/main/src%20hop%20server"))()
                end)
                if not success then warn("Hop Server failed:", err) end
            end)
            wait(3)
        end
    end)
end)

-- ===== Close Main UI Logic =====
closeBtn.MouseButton1Click:Connect(function()
    -- ปิด Float + ลบ UI
    Floating = false
    floatBtn.Text = "Float Off"
    local floatUI = playerGui:FindFirstChild("FloatUI")
    if floatUI then floatUI:Destroy() end
    if typeof(disableFloat) == "function" then pcall(disableFloat) end

    -- ปิด AutoLaser + ลบ UI
    AutoLaser = false
    autoLaserBtn.Text = "Auto Laser OFF"
    local laserUI = playerGui:FindFirstChild("AutoLaserUI")
    if laserUI then laserUI:Destroy() end
    if typeof(unequipLaser) == "function" then pcall(unequipLaser) end

    -- ลบ UI หลัก
    if screenGui and screenGui.Parent then
        screenGui:Destroy()
    end
end)
