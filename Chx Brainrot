-- ===== Services =====
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ===== ScreenGui =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CHX_GUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- ===== Main Frame =====
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0,220,0,215)
mainFrame.Position = UDim2.new(0.05,0,0.25,0)
mainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0,20)

-- ===== Rainbow Border =====
local border = Instance.new("UIStroke")
border.Parent = mainFrame
border.Thickness = 3
border.Color = Color3.fromHSV(0,1,1)
border.LineJoinMode = Enum.LineJoinMode.Round
local hue = 0
RunService.RenderStepped:Connect(function()
    hue = (hue + 0.002) % 1
    border.Color = Color3.fromHSV(hue,1,1)
end)

-- ===== Top Bar =====
local topBar = Instance.new("Frame")
topBar.Size = UDim2.new(1,0,0,35)
topBar.Position = UDim2.new(0,0,0,0)
topBar.BackgroundTransparency = 1
topBar.Parent = mainFrame

-- Title
local titleText = Instance.new("TextLabel")
titleText.Size = UDim2.new(1,-60,1,0)
titleText.Position = UDim2.new(0,5,0,0)
titleText.BackgroundTransparency = 1
titleText.Text = "CHX Brainrot"
titleText.Font = Enum.Font.GothamBold
titleText.TextSize = 18
titleText.TextColor3 = Color3.fromRGB(255,255,255)
titleText.TextXAlignment = Enum.TextXAlignment.Left
titleText.Parent = topBar

-- Close Button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0,25,0,25)
closeBtn.Position = UDim2.new(1,-5,0,5)
closeBtn.AnchorPoint = Vector2.new(1,0)
closeBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)
closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
closeBtn.Text = "X"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 14
closeBtn.Parent = topBar
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0,12)

-- Toggle Button (พับ/ขยาย UI)
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0,25,0,25)
toggleBtn.Position = UDim2.new(1,-35,0,5)
toggleBtn.AnchorPoint = Vector2.new(1,0)
toggleBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
toggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
toggleBtn.Text = "-"
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 18
toggleBtn.Parent = topBar
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0,12)

-- ===== UI Container =====
local uiFrame = Instance.new("Frame")
uiFrame.Size = UDim2.new(1,0,1,-35)
uiFrame.Position = UDim2.new(0,0,0,35)
uiFrame.BackgroundTransparency = 1
uiFrame.Parent = mainFrame

-- ===== Buttons =====
local buttons = {}
local function createButton(text, y, color)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.9,0,0,35)
    btn.Position = UDim2.new(0.05,0,0,y)
    btn.BackgroundColor3 = color
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.Text = text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 16
    btn.Parent = uiFrame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,12)
    table.insert(buttons, btn)
    return btn
end

local floatBtn = createButton("Float Off",0,Color3.fromRGB(50,50,50))
local autoLaserBtn = createButton("Auto Laser OFF",45,Color3.fromRGB(70,70,70))
local functionBtn = createButton("Run Function",90,Color3.fromRGB(80,80,80))
local hopBtn = createButton("Hop Server",135,Color3.fromRGB(50,50,50))

-- ===== Toggle UI Visibility (Mini Mode) =====
local uiExpanded = true
toggleBtn.MouseButton1Click:Connect(function()
    uiExpanded = not uiExpanded
    if uiExpanded then
        -- ขยาย UI
        mainFrame.Size = UDim2.new(0,220,0,215)
        uiFrame.Visible = true
        for _,btn in ipairs(buttons) do
            btn.Visible = true
        end
        toggleBtn.Text = "-"
    else
        -- พับเหลือแต่ TopBar
        mainFrame.Size = UDim2.new(0,220,0,35)
        uiFrame.Visible = false
        for _,btn in ipairs(buttons) do
            btn.Visible = false
        end
        toggleBtn.Text = "+"
    end
end)

-- ===== Drag Main Frame =====
local dragging=false
local dragInput, dragStart, startPos
local function update(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(
        startPos.X.Scale,
        startPos.X.Offset + delta.X,
        startPos.Y.Scale,
        startPos.Y.Offset + delta.Y
    )
end

topBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging=true
        dragStart=input.Position
        startPos=mainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState==Enum.UserInputState.End then dragging=false end
        end)
    end
end)

topBar.InputChanged:Connect(function(input)
    if input.UserInputType==Enum.UserInputType.MouseMovement then
        dragInput=input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input==dragInput and dragging then
        update(input)
    end
end)

-- ===== Close Button =====
closeBtn.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)





-- ===== Float Logic =====
local Floating = false
local FloatPart, FloatHeight = nil, -2
local FloatConn, char, root

local function updateCharacter()
    char = player.Character
    if char then
        root = char:WaitForChild("HumanoidRootPart")
    end
end
updateCharacter()
player.CharacterAdded:Connect(updateCharacter)

local function enableFloat()
    if Floating then return end
    if not root then updateCharacter() end
    Floating = true
    floatBtn.Text = "Float On"
    FloatPart = Instance.new("Part")
    FloatPart.Size = Vector3.new(3,0.2,3)
    FloatPart.Anchored = true
    FloatPart.Transparency = 1
    FloatPart.Parent = workspace
    Instance.new("CylinderHandleAdornment", FloatPart)
    FloatConn = RunService.Heartbeat:Connect(function()
        if FloatPart and root then
            FloatPart.CFrame = CFrame.new(root.Position.X, root.Position.Y+FloatHeight, root.Position.Z)
        end
    end)
end

local function disableFloat()
    if not Floating then return end
    Floating = false
    floatBtn.Text = "Float Off"
    if FloatConn then FloatConn:Disconnect() FloatConn=nil end
    if FloatPart then FloatPart:Destroy() FloatPart=nil end
end

floatBtn.MouseButton1Click:Connect(function()
    if Floating then disableFloat() else enableFloat() end
end)

-- ===== Auto Laser Logic =====
local AutoLaser = false
local LaserDistance = 60
local Net = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net")
local Remote = Net:WaitForChild("RE/UseItem")
local PlayerMouse = require(ReplicatedStorage.Packages.PlayerMouse)

local function getRoot()
    local char = player.Character
    if char then return char:FindFirstChild("HumanoidRootPart") end
end

local function equipLaser()
    local backpack = player:WaitForChild("Backpack")
    local character = player.Character
    local humanoid = character:FindFirstChild("Humanoid")
    local laserTool = backpack:FindFirstChild("Laser Cape") or character:FindFirstChild("Laser Cape")
    if laserTool and humanoid then
        if laserTool.Parent ~= character then
            humanoid:EquipTool(laserTool)
            RunService.RenderStepped:Wait()
        end
        return laserTool
    end
    return nil
end

local function unequipLaser()
    local character = player.Character
    local backpack = player:WaitForChild("Backpack")
    local laserTool = character:FindFirstChild("Laser Cape")
    if laserTool then laserTool.Parent=backpack end
end

autoLaserBtn.MouseButton1Click:Connect(function()
    AutoLaser = not AutoLaser
    autoLaserBtn.Text = "Auto Laser "..(AutoLaser and "ON" or "OFF")
    if not AutoLaser then unequipLaser() end
end)

-- Main Auto Laser loop
spawn(function()
    while true do
        if AutoLaser then
            local root = getRoot()
            if root then
                local myPos=root.Position
                local laserTool=equipLaser()
                if laserTool then
                    for _, targetPlayer in pairs(Players:GetPlayers()) do
                        if targetPlayer~=player and targetPlayer.Character and targetPlayer.Character:FindFirstChild("UpperTorso") then
                            local targetPart=targetPlayer.Character.UpperTorso
                            if (myPos-targetPart.Position).Magnitude<=LaserDistance then
                                laserTool:Activate()
                                local args={targetPart.Position,targetPart}
                                Remote:FireServer(unpack(args))
                            end
                        end
                    end
                end
            end
        end
        wait(0.01)
    end
end)

-- ===== Function Button =====
functionBtn.MouseButton1Click:Connect(function()
    local url = "https://raw.githubusercontent.com/Chxtoqfee12/Chx-Braintoy/refs/heads/main/src%20function"
    local success, funcOrErr = pcall(function()
        return loadstring(game:HttpGet(url))()
    end)
    if not success then
        warn("Failed to load function:", funcOrErr)
    end
end)

-- ===== Hop Server =====
hopBtn.MouseButton1Click:Connect(function()
    getgenv().ALLOWED_PLACE_ID = 109983668079237
    getgenv().RETRY_DELAY = 2
    getgenv().MIN_PLAYERS = 2
    getgenv().MAX_PLAYERS = 7
    getgenv().CHECK_COOLDOWN = 5
    getgenv().SOUND_ID = 91907916191505
    getgenv().MODEL_SEARCH_SETTINGS = {}
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Chxtoqfee12/Chx-Braintoy/refs/heads/main/src%20hop%20server"))()
end)

-- ===== Close Button =====
closeBtn.MouseButton1Click:Connect(function()
    AutoLaser=false
    autoLaserBtn.Text="Auto Laser OFF"
    unequipLaser()
    disableFloat()
    screenGui:Destroy()
end)
